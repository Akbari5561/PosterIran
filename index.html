<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پوستر ایران</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2196f3">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            direction: rtl;
            text-align: center;
            background: #f8f8f8;
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        .image-box {
            @apply border border-gray-200 p-4 m-4 rounded-xl shadow-lg bg-white flex flex-col items-center justify-between w-64;
            min-height: 320px; /* Ensure consistent height */
        }
        .image-box img {
            @apply w-40 h-40 object-cover rounded-md mb-3;
        }
        .image-container {
            @apply flex flex-wrap justify-center gap-6 p-6;
        }
        .button-style {
            @apply bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 ease-in-out transform hover:scale-105;
        }
        .input-style {
            @apply border border-gray-300 p-2 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent;
        }
        .select-style {
            @apply border border-gray-300 p-2 rounded-md bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>

<h1 class="text-4xl font-bold text-gray-800 mb-2 cursor-pointer" onclick="showAdminLogin()">پوستر ایران</h1>
<p id="subtitle" class="text-xl text-gray-600 mb-4">چاپ انواع پوسترهای آموزشی</p>
<div id="address" class="text-gray-700 leading-relaxed mb-6">
    <p>تهران : خیابان پانزده خرداد</p>
    <p>بازار آهنگران</p>
    <p>کوچه مسجد جامع</p>
    <p>پاساژ کاغذ و تحریر</p>
    <p>زیرزمین اول - پلاک 74</p>
</div>
<div id="contact" class="text-gray-700 mb-8">
    <p>تلفن: 02155611875</p>
    <p>موبایل: 09010195885</p>
</div>

<div id="loginSection" class="flex flex-col space-y-4">
    <button class="button-style" onclick="enterAsUser()">ورود به گالری</button>
    <button class="button-style bg-gray-500 hover:bg-gray-600" onclick="showAdminLogin()">ورود ادمین</button>
</div>

<div id="adminLogin" class="hidden flex flex-col space-y-4 max-w-sm w-full">
    <input type="password" id="adminPassword" placeholder="رمز ورود ادمین" class="input-style">
    <button class="button-style" onclick="loginAsAdmin()">ورود ادمین</button>
    <button class="button-style bg-gray-500 hover:bg-gray-600" onclick="logout()">بازگشت</button>
</div>

<div id="adminPanel" class="hidden flex flex-col space-y-4 max-w-3xl w-full p-6 bg-white rounded-lg shadow-md">
    <h2 class="text-2xl font-semibold mb-4">پنل مدیریت</h2>
    <input type="file" id="imageFile" accept="image/*" class="input-style p-1">
    <input type="text" id="productName" placeholder="نام محصول" class="input-style">
    <input type="number" id="unitPrice" placeholder="قیمت واحد (ریال)" class="input-style">
    <select id="groupSelect" class="select-style">
        <option value="1">سایز ۲۹×۲۱ دوروچاپ</option>
        <option value="2">سایز ۵۰×۳۵ یکروچاپ</option>
        <option value="3">سایز ۵۰×۳۵ دوروچاپ</option>
        <option value="4">سایز ۷۰×۵۰ یکروچاپ</option>
        <option value="5">سایز ۷۰×۵۰ یووی‌دار</option>
    </select>
    <button class="button-style" onclick="addImage()">افزودن تصویر و محصول</button>
    <button class="button-style bg-gray-500 hover:bg-gray-600" onclick="logout()">بازگشت</button>
    <h3 class="text-xl font-semibold mt-6">محصولات موجود (برای مدیریت)</h3>
    <div class="image-container" id="adminImagesContainer"></div>
</div>

<div id="categorySelect" class="hidden flex items-center justify-center space-x-4 mb-6">
    <span class="text-lg font-medium">گروه:</span>
    <select onchange="changeGroup(this.value)" class="select-style">
        <option value="1">سایز ۲۹×۲۱ دوروچاپ</option>
        <option value="2">سایز ۵۰×۳۵ یکروچاپ</option>
        <option value="3">سایز ۵۰×۳۵ دوروچاپ</option>
        <option value="4">سایز ۷۰×۵۰ یکروچاپ</option>
        <option value="5">سایز ۷۰×۵۰ یووی‌دار</option>
    </select>
    <button class="button-style" onclick="showCart()">🛒 سبد خرید</button>
    <button class="button-style bg-gray-500 hover:bg-gray-600" onclick="logoutUser()">بازگشت</button>
</div>

<div id="gallery" class="hidden w-full">
    <div class="image-container" id="imagesContainer"></div>
</div>

<div id="cartSection" class="hidden w-full max-w-3xl p-6 bg-white rounded-lg shadow-md mt-6">
    <h3 class="text-2xl font-semibold mb-4">🛒 سبد خرید</h3>
    <div id="cartList" class="flex flex-col space-y-3 mb-6 text-right"></div>
    <div class="flex justify-center space-x-4">
        <button class="button-style bg-green-600 hover:bg-green-700" onclick="downloadAndSendOrder()">ثبت سفارش و ارسال به واتس‌اپ</button>
        <button class="button-style bg-gray-500 hover:bg-gray-600" onclick="hideCart()">بازگشت</button>
    </div>
</div>

<script>
    // --- Global State & Initialization ---
    let products = []; // Will be loaded from localStorage
    let cartItems = []; // Will be loaded from localStorage

    // This runs when the page is fully loaded
    document.addEventListener('DOMContentLoaded', () => {
        loadProductsFromLocalStorage(); // Load product data
        loadCartFromLocalStorage();     // Load cart data

        // Determine initial view based on saved state or default
        const appState = localStorage.getItem('appState');
        if (appState === 'admin') {
            showAdminLogin();
            // Note: Admin products are loaded after successful loginAsAdmin
        } else if (appState === 'user') {
            enterAsUser();
        } else {
            // Default view: login section
            document.getElementById("loginSection").classList.remove("hidden");
            document.getElementById("subtitle").classList.remove("hidden");
            document.getElementById("address").classList.remove("hidden");
            document.getElementById("contact").classList.remove("hidden");
        }
    });

    // --- Product Data Management (Local Storage) ---
    function loadProductsFromLocalStorage() {
        products = JSON.parse(localStorage.getItem("products")) || [];
    }

    function saveProductsToLocalStorage() {
        localStorage.setItem("products", JSON.stringify(products));
    }

    // --- UI State Management Functions ---
    function showAdminLogin() {
        document.getElementById("adminLogin").classList.remove("hidden");
        document.getElementById("loginSection").classList.add("hidden");
        document.getElementById("subtitle").classList.add("hidden");
        document.getElementById("address").classList.add("hidden");
        document.getElementById("contact").classList.add("hidden");
        localStorage.setItem('appState', 'admin');
    }

    function enterAsUser() {
        document.getElementById("loginSection").classList.add("hidden");
        document.getElementById("categorySelect").classList.remove("hidden");
        document.getElementById("gallery").classList.remove("hidden");
        document.getElementById("subtitle").classList.add("hidden");
        document.getElementById("address").classList.add("hidden");
        document.getElementById("contact").classList.add("hidden");
        localStorage.setItem('appState', 'user');
        // Load products for the default selected group
        loadProductsForUser(document.getElementById("categorySelect").querySelector('select').selectedOptions[0].text);
    }

    function logoutUser() {
        document.getElementById("categorySelect").classList.add("hidden");
        document.getElementById("gallery").classList.add("hidden");
        document.getElementById("loginSection").classList.remove("hidden");
        document.getElementById("subtitle").classList.remove("hidden");
        document.getElementById("address").classList.remove("hidden");
        document.getElementById("contact").classList.remove("hidden");
        localStorage.removeItem('appState'); // Clear state
    }

    function loginAsAdmin() {
        const password = document.getElementById("adminPassword").value;
        if (password === "Alireza55") { // WARNING: Insecure hardcoded password!
            document.getElementById("adminLogin").classList.add("hidden");
            document.getElementById("adminPanel").classList.remove("hidden");
            // Show gallery for admin view too
            document.getElementById("gallery").classList.remove("hidden");
            loadProductsForAdmin(); // Load all products for admin
        } else {
            alert("رمز اشتباه است");
        }
    }

    function logout() {
        document.getElementById("adminPanel").classList.add("hidden");
        document.getElementById("adminLogin").classList.add("hidden");
        document.getElementById("loginSection").classList.remove("hidden");
        document.getElementById("subtitle").classList.remove("hidden");
        document.getElementById("address").classList.remove("hidden");
        document.getElementById("contact").classList.remove("hidden");
        document.getElementById("gallery").classList.add("hidden"); // Hide gallery on logout
        localStorage.removeItem('appState'); // Clear state
    }

    function changeGroup(groupId) {
        const groupName = {
            1: "سایز ۲۹×۲۱ دوروچاپ",
            2: "سایز ۵۰×۳۵ یکروچاپ",
            3: "سایز ۵۰×۳۵ دوروچاپ",
            4: "سایز ۷۰×۵۰ یکروچاپ",
            5: "سایز ۷۰×۵۰ یووی‌دار"
        }[groupId];
        // If in admin panel, also update the admin view
        if (document.getElementById("adminPanel").classList.contains("hidden")) {
            loadProductsForUser(groupName); // User view
        } else {
            loadProductsForAdmin(groupName); // Admin view (filtered by group)
        }
    }

    function showCart() {
        document.getElementById("cartSection").classList.remove("hidden");
        document.getElementById("gallery").classList.add("hidden");
        document.getElementById("categorySelect").classList.add("hidden");
        displayCartItems(); // Ensure cart display is up-to-date
    }

    function hideCart() {
        document.getElementById("cartSection").classList.add("hidden");
        document.getElementById("gallery").classList.remove("hidden");
        document.getElementById("categorySelect").classList.remove("hidden");
    }

    // --- Product Management Functions (Local Storage & Base64 Images) ---
    function addImage() {
        const imageFile = document.getElementById("imageFile").files[0];
        const productName = document.getElementById("productName").value.trim();
        const unitPrice = parseInt(document.getElementById("unitPrice").value);
        const group = document.getElementById("groupSelect").selectedOptions[0].text;

        if (!imageFile || !productName || isNaN(unitPrice) || unitPrice <= 0) {
            alert("لطفا تمام فیلدها را به درستی پر کنید و یک عکس انتخاب کنید.");
            return;
        }

        // Check file size (e.g., limit to 1MB to avoid localStorage overflow)
        if (imageFile.size > 1024 * 1024) { // 1MB
            alert("اندازه عکس بیش از حد مجاز (1MB) است. لطفا عکس کوچکتری انتخاب کنید.");
            return;
        }

        const reader = new FileReader();
        reader.onload = function(event) {
            const base64Image = event.target.result; // This is the Base64 string

            const newProduct = {
                id: Date.now(), // Unique ID based on timestamp
                imageURL: base64Image, // Storing Base64 string here
                productName: productName,
                unitPrice: unitPrice,
                group: group,
                createdAt: new Date().toISOString() // Store creation time
            };
            products.push(newProduct);
            saveProductsToLocalStorage();

            alert("محصول و عکس با موفقیت اضافه شدند.");
            // Clear input fields
            document.getElementById("imageFile").value = "";
            document.getElementById("productName").value = "";
            document.getElementById("unitPrice").value = "";
            loadProductsForAdmin(); // Reload admin view to show new product
        };
        reader.onerror = function(error) {
            console.error("Error reading file:", error);
            alert("خطا در خواندن فایل عکس.");
        };
        reader.readAsDataURL(imageFile); // Read the file as a Base64 data URL
    }

    function loadProductsForUser(groupName) {
        const container = document.getElementById("imagesContainer");
        container.innerHTML = '<div class="text-gray-500 text-center">در حال بارگذاری محصولات...</div>';

        const filteredProducts = products
            .filter(p => p.group === groupName)
            .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)); // Sort by newest first

        container.innerHTML = "";
        if (filteredProducts.length === 0) {
            container.innerHTML = '<div class="text-gray-500 text-center">محصولی در این گروه یافت نشد.</div>';
            return;
        }

        filteredProducts.forEach(product => {
            const imageBox = document.createElement("div");
            imageBox.className = "image-box";

            const img = document.createElement("img");
            img.src = product.imageURL; // Direct Base64 string as source
            img.alt = product.productName;
            img.onerror = function() { this.src = `https://placehold.co/160x160/cccccc/333333?text=Broken+Image`; };

            const nameElem = document.createElement("div");
            nameElem.className = "caption text-sm text-gray-600 mb-2 font-bold";
            nameElem.textContent = product.productName + " - " + product.group;

            const priceDisplay = document.createElement("div");
            priceDisplay.className = "text-md font-medium text-gray-800 mb-2";
            priceDisplay.textContent = `قیمت واحد: ${product.unitPrice.toLocaleString()} ریال`;

            const quantitySelect = document.createElement("select");
            quantitySelect.className = "select-style mb-3 w-full";
            [20, 50, 100, 200, 300, 400, 500].forEach(q => {
                const opt = document.createElement("option");
                opt.value = q;
                opt.textContent = q + " عدد";
                quantitySelect.appendChild(opt);
            });

            const addToCartBtn = document.createElement("button");
            addToCartBtn.textContent = "➕ افزودن به سبد";
            addToCartBtn.className = "button-style w-full mt-auto";
            addToCartBtn.onclick = () => {
                const qty = parseInt(quantitySelect.value);
                addToCart(product.id, product.productName, product.group, qty, product.unitPrice);
            };

            imageBox.appendChild(img);
            imageBox.appendChild(nameElem);
            imageBox.appendChild(priceDisplay);
            imageBox.appendChild(quantitySelect);
            imageBox.appendChild(addToCartBtn);

            container.appendChild(imageBox);
        });
    }

    function loadProductsForAdmin(filterGroup = null) {
        const container = document.getElementById("adminImagesContainer");
        container.innerHTML = '<div class="text-gray-500 text-center">در حال بارگذاری محصولات برای مدیریت...</div>';

        let productsToDisplay = products;
        if (filterGroup) {
            productsToDisplay = products.filter(p => p.group === filterGroup);
        }

        productsToDisplay.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)); // Sort by newest first

        container.innerHTML = "";
        if (productsToDisplay.length === 0) {
            container.innerHTML = '<div class="text-gray-500 text-center">محصولی برای مدیریت یافت نشد.</div>';
            return;
        }

        productsToDisplay.forEach(product => {
            const imageBox = document.createElement("div");
            imageBox.className = "image-box";

            const img = document.createElement("img");
            img.src = product.imageURL; // Direct Base64 string as source
            img.alt = product.productName;
            img.onerror = function() { this.src = `https://placehold.co/160x160/cccccc/333333?text=Broken+Image`; };

            const nameElem = document.createElement("div");
            nameElem.className = "caption text-sm text-gray-600 mb-2 font-bold";
            nameElem.textContent = product.productName + " - " + product.group;

            const priceDisplay = document.createElement("div");
            priceDisplay.className = "text-md font-medium text-gray-800 mb-2";
            priceDisplay.textContent = `قیمت واحد: ${product.unitPrice.toLocaleString()} ریال`;

            const editBtn = document.createElement("button");
            editBtn.textContent = "✏️ ویرایش";
            editBtn.className = "button-style bg-yellow-500 hover:bg-yellow-600 w-full mb-2";
            editBtn.onclick = () => {
                // To change image, user needs to select a new file and read its Base64
                const newImageFileSelected = prompt("آیا می‌خواهید عکس را تغییر دهید؟ (بله/خیر)");
                let newImagePromise;

                if (newImageFileSelected && newImageFileSelected.toLowerCase() === 'بله') {
                    newImagePromise = new Promise((resolve, reject) => {
                        const input = document.createElement('input');
                        input.type = 'file';
                        input.accept = 'image/*';
                        input.onchange = (e) => {
                            const file = e.target.files[0];
                            if (file) {
                                if (file.size > 1024 * 1024) { // 1MB limit
                                    alert("اندازه عکس بیش از حد مجاز (1MB) است. لطفا عکس کوچکتری انتخاب کنید.");
                                    reject(new Error("File too large"));
                                    return;
                                }
                                const reader = new FileReader();
                                reader.onload = (event) => resolve(event.target.result);
                                reader.onerror = (error) => reject(error);
                                reader.readAsDataURL(file);
                            } else {
                                resolve(product.imageURL); // No new file selected, keep old image
                            }
                        };
                        input.click();
                    });
                } else {
                    newImagePromise = Promise.resolve(product.imageURL); // Keep existing image
                }

                newImagePromise.then(newImageBase64 => {
                    const newName = prompt("نام جدید محصول:", product.productName);
                    const newPrice = prompt("قیمت جدید:", product.unitPrice);

                    if (newName !== null && newPrice !== null) {
                        const parsedPrice = parseInt(newPrice);
                        if (!isNaN(parsedPrice) && parsedPrice > 0) {
                            updateProduct(product.id, newImageBase64, newName.trim(), parsedPrice);
                        } else {
                            alert("قیمت جدید معتبر نیست.");
                        }
                    }
                }).catch(error => {
                    console.error("Error during image update:", error);
                    alert("خطا در بروزرسانی عکس: " + error.message);
                });
            };

            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "🗑️ حذف";
            deleteBtn.className = "button-style bg-red-600 hover:bg-red-700 w-full";
            deleteBtn.onclick = () => {
                if (confirm("آیا مطمئن هستید؟ این عمل قابل بازگشت نیست.")) {
                    deleteProduct(product.id);
                }
            };

            imageBox.appendChild(img);
            imageBox.appendChild(nameElem);
            imageBox.appendChild(priceDisplay);
            imageBox.appendChild(editBtn);
            imageBox.appendChild(deleteBtn);

            container.appendChild(imageBox);
        });
    }

    function updateProduct(productId, newImageURL, newProductName, newUnitPrice) {
        const productIndex = products.findIndex(p => p.id === productId);
        if (productIndex > -1) {
            products[productIndex].imageURL = newImageURL;
            products[productIndex].productName = newProductName;
            products[productIndex].unitPrice = newUnitPrice;
            saveProductsToLocalStorage();
            alert("بروزرسانی انجام شد.");
            loadProductsForAdmin(); // Reload admin view
        }
    }

    function deleteProduct(productId) {
        products = products.filter(p => p.id !== productId);
        saveProductsToLocalStorage();
        alert("محصول حذف شد.");
        loadProductsForAdmin(); // Reload admin view
    }

    // --- Shopping Cart Logic (using localStorage) ---
    function loadCartFromLocalStorage() {
        const storedCart = localStorage.getItem("cartItems");
        if (storedCart) {
            cartItems = JSON.parse(storedCart);
        } else {
            cartItems = [];
        }
        displayCartItems(); // Always display cart content on load
    }

    function saveCartToLocalStorage() {
        localStorage.setItem("cartItems", JSON.stringify(cartItems));
    }

    function addToCart(productId, productName, group, quantity, unitPrice) {
        const existingItemIndex = cartItems.findIndex(item => item.productId === productId);

        if (existingItemIndex > -1) {
            cartItems[existingItemIndex].quantity += quantity;
        } else {
            cartItems.push({
                productId,
                productName,
                group,
                quantity,
                unitPrice
            });
        }
        saveCartToLocalStorage();
        alert("محصول با موفقیت به سبد خرید اضافه شد ✅");
        displayCartItems(); // Update cart display immediately
    }

    function removeFromCart(productId) {
        cartItems = cartItems.filter(item => item.productId !== productId);
        saveCartToLocalStorage();
        displayCartItems();
        alert("محصول از سبد خرید حذف شد.");
    }

    function displayCartItems() {
        const cartList = document.getElementById("cartList");
        cartList.innerHTML = "";
        if (cartItems.length === 0) {
            cartList.innerHTML = '<div class="text-gray-500 text-center">سبد خرید خالی است 🧺</div>';
            return;
        }

        // Group and sort items by group name
        const groupedItems = {};
        cartItems.forEach(item => {
            if (!groupedItems[item.group]) {
                groupedItems[item.group] = [];
            }
            groupedItems[item.group].push(item);
        });

        for (const groupName in groupedItems) {
            const groupTitle = document.createElement("h4");
            groupTitle.className = "text-lg font-semibold mt-4 mb-2 border-b pb-1";
            groupTitle.textContent = `گروه: ${groupName}`;
            cartList.appendChild(groupTitle);

            groupedItems[groupName].forEach(item => {
                const total = item.unitPrice * item.quantity;
                const cartItemDiv = document.createElement("div");
                cartItemDiv.className = "flex items-center justify-between p-2 border-b border-gray-100 last:border-b-0";
                cartItemDiv.innerHTML = `
                    <div class="flex-grow text-right">
                        <span class="font-semibold">${item.productName}</span> | تعداد: ${item.quantity} | <span class="font-bold">${total.toLocaleString()} ریال</span>
                    </div>
                    <button class="bg-red-500 text-white p-1 rounded-md hover:bg-red-600 transition duration-200 mr-2 text-sm" onclick="removeFromCart('${item.productId}')">حذف</button>
                `;
                cartList.appendChild(cartItemDiv);
            });
        }
    }

    // Send order to WhatsApp with grouped and sorted items
    function downloadAndSendOrder() {
        if (cartItems.length === 0) {
            alert("سبد خرید خالی است.");
            return;
        }

        // Structure to store order based on group
        const orderData = {};
        cartItems.forEach(item => {
            if (!orderData[item.group]) {
                orderData[item.group] = [];
            }
            orderData[item.group].push(item);
        });

        let message = "🛒 سفارش شما:\n\n";
        for (const group in orderData) {
            message += `گروه: ${group}\n`;
            orderData[group].forEach(item => {
                const total = item.unitPrice * item.quantity;
                message += `- ${item.productName} | تعداد: ${item.quantity} | 💵 ${total.toLocaleString()} ریال\n`;
            });
            message += "\n";
        }

        const encodedMessage = encodeURIComponent(message);
        const phoneNumber = "989010195885"; // Your WhatsApp phone number
        window.open(`https://wa.me/${phoneNumber}?text=${encodedMessage}`, "_blank");

        // Clear cart after sending
        alert("سفارش ارسال شد و سبد خرید پاک شد ✅");
        cartItems = []; // Empty the cart array
        saveCartToLocalStorage(); // Save the empty cart
        displayCartItems(); // Update display
        hideCart(); // Go back to gallery
    }

    // --- Service Worker Registration ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function () {
            navigator.serviceWorker.register('/service-worker.js')
                .then(reg => console.log("Service Worker registered:", reg))
                .catch(err => console.error("Service Worker registration failed:", err));
        });
    }
</script>

<footer class="mt-auto py-6 text-gray-500 text-sm">
    <p>&copy; 2023 پوستر ایران. تمامی حقوق محفوظ است.</p>
</footer>
</body>
</html>