<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ر ایران</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="icon" href="/icons/favicon.ico" type="image/x-icon">
  <link rel="shortcut icon" href="/icons/favicon.ico" type="image/x-icon">

  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon-180x180.png">
  <link rel="apple-touch-icon" sizes="167x167" href="/icons/apple-touch-icon-167x167.png">

  <link rel="manifest" href="/icons/manifest.json">
  <meta name="theme-color" content="#2196f3">

  <meta property="og:title" content="پوستر ایران">
  <meta property="og:description" content="چاپ انواع پوسترهای آموزشی">
  <meta property="og:image" content="/icons/og-image.jpg"> <meta property="og:url" content="https://akbari5561.github.io/PosterIran/">

  <style>

    h1 {
      color: #1976d2;
      cursor: pointer;
      margin: 0; /* حذف مارجین پیش‌فرض h1 برای کنترل بهتر فاصله در فلکس‌باکس */
      font-size: 2em; /* سایز فونت h1، می‌تونید تنظیم کنید */
    }

    body {
      font-family: sans-serif;
      direction: rtl;
      background: #f0f4f8;
      color: #333;
      padding: 20px;
      text-align: center;
      margin: 0; /* Remove default body margin */
      display: flex;
      flex-direction: column;
      min-height: 100vh; /* Ensure body takes full viewport height */
    }

    h1 {
      color: #1976d2;
      cursor: pointer;
    }

    button {
      background-color: #2196f3;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #1976d2;
    }
    button.remove-btn {
      background-color: #f44336;
    }
    button.remove-btn:hover {
      background-color: #d32f2f;
    }
    button.clear-cart-btn {
      background-color: #ff9800; /* Orange for clear cart */
    }
    button.clear-cart-btn:hover {
      background-color: #fb8c00;
    }
    /* Style for quantity dropdowns in both gallery and cart */
    .quantity-select {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin: 5px;
      width: 60px; /* عرض ثابت برای جا شدن عدد سه رقمی */
      min-width: 50px; /* حداقل عرض مجاز */
      max-width: 70px; /* حداکثر عرض مجاز */
      box-sizing: border-box; /* برای اینکه پدینگ و بردر روی عرض حساب بشن */
      text-align: center; /* متن داخلش وسط‌چین بشه */
  }
    /* Style for the Group Selection dropdown */
    .group-select-fixed {
    width: 150px;   /* عرض ثابت برای دروپ‌داون گروه */
    min-width: 120px; /* حداقل عرض */
    max-width: 200px; /* حداکثر عرض */
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
    margin: 5px;
    box-sizing: border-box; /* برای محاسبه درست عرض */
    text-align: right; /* متن راست‌چین باشه */
    }
    /* Main sections styling */
    #mainSection, #adminLogin, #gallery, #cartSection {
        margin-top: 20px;
        flex-grow: 1; /* Allow sections to take available space */
        display: none; /* Hidden by default, controlled by JS */
        flex-direction: column; /* For consistent layout */
    }
    
    /* Admin login is hidden by default, shown by JS only on title click */
    #adminLogin {
        display: none;
    }
    #cartSection {
      background: #fff;
      padding: 15px;
      border-radius: 10px;
      text-align: right;
    }
    #address {
      margin-top: 10px;
    }
    .image-box {
      background: white;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center;
      width: calc(50% - 15px); /* Default for 2 items per row with gap */
      box-sizing: border-box; /* Include padding/border in width */
    }

    .image-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
      flex-grow: 1; /* Allow container to grow */
    }

    img {
      width: 100%;
      height: auto; /* Reverted to auto for original aspect ratio */
      border-radius: 8px;
      margin-bottom: 10px;
    }

    select, input[type="password"] {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin: 5px;
      width: calc(100% - 10px); /* Adjust width */
      box-sizing: border-box; /* Include padding/border in width */
    }
    
    .cart-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px dashed #eee;
    }
    .cart-item:last-child {
        border-bottom: none;
    }
    .quantity-control {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .cart-item-info {
        text-align: right;
        flex-grow: 1; /* Allow info section to take available space */
        margin-left: 10px; /* Space between info and controls */
    }
    .cart-item-actions {
        display: flex;
        align-items: center;
    }
    .cart-item-actions span {
        margin-left: 10px;
        font-weight: bold;
    }
    .cart-item-actions button {
      margin-left: 5px;
    }
    /* Controls at the top/bottom of gallery */
  .gallery-controls {
      display: flex;
    flex-wrap: wrap; /* اجازه می‌دهیم آیتم‌ها به خط بعدی شکسته شوند */
    justify-content: center; /* آیتم‌ها را در مرکز قرار می‌دهد */
    align-items: center;
    width: 100%;
    padding: 10px 0;
    background-color: #e0e7ff;
    border-top: 1px solid #c3d4e6;
    box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
    z-index: 1000;
    gap: 10px; /* فاصله بین آیتم‌های اصلی فلکس (wrapper و دکمه) */
}
  .group-selection-wrapper {
      display: flex; /* این div خودش یک فلکس‌کانتینر می‌شود */
      align-items: center;
      gap: 5px; /* فاصله بین لیبل و سلکت دروپ‌داون */
      margin-right: 10px; /* فاصله از دکمه "سبد خرید" (اگر در یک ردیف باشد) */
  }
    #gallery-bottom-controls {
        margin-top: auto; /* Push to bottom of gallery content */
        position: sticky; /* Make it sticky */
        bottom: 0; /* Stick to the bottom */
        left: 0;
        right: 0;
        border-bottom: none; /* No bottom border for the very bottom one */
    }
    #gallery-top-controls {
        margin-bottom: 10px;
        border-top: none; /* No top border for the very top one */
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); /* Shadow at the bottom */
    }
    .gallery-controls button {
        margin: 0;
    }
    .in-cart-display {
        font-size: 0.9em;
        color: #007BFF; /* Blue color for in-cart message */
        margin-top: 5px;
        font-weight: bold;
    }
@media (max-width: 600px) {
    .image-box {
        width: calc(100% - 10px);
    }
    .gallery-controls {
        flex-direction: column; /* در موبایل همه به صورت ستونی */
        gap: 10px;
    }
    .group-selection-wrapper {
        width: calc(100% - 20px); /* در موبایل، wrapper هم تمام عرض شود */
        justify-content: center; /* محتوای wrapper در موبایل وسط‌چین شود */
        margin-right: 0; /* مارجین حذف شود */
    }
    .gallery-controls button {
        width: calc(100% - 20px);
    }
    /* نیازی به تغییر .gallery-controls select نیست زیرا با min/max-width کنترل می‌شود */
} 
  </style>
  
</head>
<body>

<h1 onclick="showAdminLogin()">پوستر ایران</h1>
<p id="subtitle">چاپ انواع پوسترهای آموزشی</p>
<div id="mainSection">
  <div id="address">
    <p>تهران : خیابان پانزده خرداد</p>
    <p>بازار آهنگران ، کوچه مسجد جامع</p>
    <p>پاساژ کاغذ و تحریر ، زیرزمین اول - پلاک 74</p>
    <p>تلفـن: 02155611875</p>
    <p>موبایل: 09010195885</p>
  </div>
  <div id="loginSection">
    <button onclick="enterAsUser()">ورود به گالری</button>
    <button onclick="showScreen('cart')">🛒 سبد خرید</button>
  </div>
  </div>

<div id="adminLogin">
  <input type="password" id="adminPassword" placeholder="رمز ورود ادمین">
  <button onclick="loginAsAdmin()">ورود ادمین</button>
</div>

<div id="gallery">
  <div id="imagesContainer" class="image-container"></div>
  <div id="gallery-bottom-controls" class="gallery-controls">
  <div class="group-selection-wrapper"> <label for="bottomGroupSelect">انتخاب گروه:</label>
    <select id="bottomGroupSelect" class="group-select-fixed" onchange="changeGroup(this.value)">
      <option value="1">سایز ۲۹×۲۱ دوروچاپ</option>
      <option value="2">سایز ۵۰×۳۵ یکروچاپ</option>
      <option value="3">سایز ۵۰×۳۵ دوروچاپ</option>
      <option value="4">سایز ۷۰×۵۰ یکروچاپ</option>
      <option value="5">سایز ۷۰×۵۰ یووی‌دار</option>
    </select>
  </div>
  <button onclick="showScreen('cart')">🛒 سبد خرید</button>
</div> </div>
<div id="cartSection">
  <h3>🛒 سبد خرید</h3>
  <div id="cartList"></div>
  <p id="totalPrice" style="font-weight: bold; font-size: 1.1em; margin-top: 15px;"></p>

  <div class="customer-info-form" style="margin-top: 20px; text-align: right; background-color: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #eee;">
    <h4 style="margin-top: 0; margin-bottom: 15px; color: #333;">اطلاعات مشتری:</h4>
    <label for="customerName" style="display: block; margin-bottom: 5px; font-weight: bold;">نام و نام خانوادگی:</label>
    <input type="text" id="customerName" placeholder="نام و نام خانوادگی خود را وارد کنید" required style="width: calc(100% - 20px); padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box;">

    <label for="customerPhone" style="display: block; margin-bottom: 5px; font-weight: bold;">شماره موبایل:</label>
    <input type="tel" id="customerPhone" placeholder="۰۹۱۲۳۴۵۶۷۸۹" required pattern="09[0-9]{9}" style="width: calc(100% - 20px); padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box;" inputmode="numeric">

    <label for="customerAddress" style="display: block; margin-bottom: 5px; font-weight: bold;">آدرس کامل تحویل:</label>
    <textarea id="customerAddress" placeholder="آدرس دقیق، شامل استان، شهر، خیابان، کوچه، پلاک، واحد و کد پستی (اختیاری)" rows="4" required style="width: calc(100% - 20px); padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; resize: vertical;"></textarea>
  </div>
  <button onclick="sendOrder()">ثبت و ارسال سفارش</button>
  <button onclick="clearCart()" class="clear-cart-btn">پاک کردن کل سبد خرید</button>
  <button onclick="showScreen('gallery')" style="background-color: #607d8b;">بازگشت به گالری</button>
</div>

<script>
const groupInfo = {
  1: {
    name: "سایز ۲۹×۲۱ دوروچاپ",
    count: 22, // تعداد فایل‌های این گروه
    price: 100000,
    // اضافه کردن لیست نام فایل‌های رندوم برای این گروه
    filenames: ["الفبای فارسی و انگلیسی.jpg", "جدول تناوبی عناصر.jpg", "اعداد همراه با ساعت و محور.jpg", "آموزش اعداد.jpg", "آموزش زمان و ساعت.jpg", "آموزش زمان وساعت 2.jpg", "آموزش ضرب و تقسیم.jpg", "تمرین ضرب و تقسیم.jpg", "جدول دوستی تمرینی.jpg", "جدول دوستی کامل.jpg", "حساب آموز اول (افقی).jpg", "حساب آموز اول (عمودی).jpg", "حساب آموز دوم (افقی).jpg", "حساب آموز دوم (عمودی).jpg", "حساب آموز پایه سوم.jpg", /*"حساب آموز چهارم و پنجم.jpg"*/, "ضرب و تمرین ضرب.jpg", /*"آموزش ضرب و تقسیم حیوانات.jpg"*/, "محیط و مساحت اشکال هندسی.jpg", /*"آموزش جمع و تفریق.jpg"*/, /*"نقشه ایران و جهان.jpg"*/, /*"جدول تقریب اعداد.jpg"*/]
  },
  2: {
    name: "سایز ۵۰×۳۵ یکروچاپ",
    count: 4, // تعداد فایل‌های این گروه
    price: 100000,
    // اضافه کردن لیست نام فایل‌های رندوم برای این گروه
    filenames: ["الفبای فارسی و شکل صداها.jpg", "جدول دوستی.jpg", "جدول ضرب کد 350.jpg", "جدول ضرب کد 351.jpg"]
  },
  3: {
    name: "سایز ۵۰×۳۵ دوروچاپ",
    count: 9, // تعداد فایل‌های این گروه
    price: 200000,
    // اضافه کردن لیست نام فایل‌های رندوم برای این گروه
    filenames: ["اعداد همراه ساعت و محور.jpg", "الفبای فارسی و انگلیسی.jpg", "آموزش ضرب و تقسیم.jpg", "تمرین ضرب و تقسیم.jpg", "جدول تناوبی عناصر.jpg", "جدول جمع و تفریق.jpg", "جدول دوستی تمرینی.jpg", "جدول دوستی کامل.jpg", "آموزش زمان و ساعت.jpg"]
  },
  4: {
    name: "سایز ۷۰×۵۰ یکروچاپ",
    count: 12, // تعداد فایل‌های این گروه
    price: 200000,
    // اضافه کردن لیست نام فایل‌های رندوم برای این گروه
    filenames: ["الفبای فارسی  شکل دار.jpg", "الفبای فارسی بدون شکل.jpg", "اعداد 1 تا 100.jpg", "اعداد ده دهی.jpg", "اعداد یک تا ده.jpg", "الفبای انگلیسی.jpg", "جدول جمع.jpg", "جدول تفریق.jpg", "جدول ضرب.jpg", "جدول تقسیم.jpg", "جدول تناوبی عناصر.jpg", "جدول دوستی.jpg"]
  },
  5: {
    name: "سایز ۷۰×۵۰ یووی‌دار",
    count: 15, // تعداد فایل‌های این گروه
    price: 250000,
    // اضافه کردن لیست نام فایل‌های رندوم برای این گروه
    filenames: ["شهرک الفبا.jpg", "جدول دوستی تمرینی.jpg", "آناتومی بدن انسان.jpg", "بدن من.jpg", "برنامه روزانه.jpg", "برنامه هفتگی.jpg", "شکل صداها و الفبای فارسی.jpg", "آموزش زمان وساعت.jpg", "ضرب تمرینی ستونی.jpg", "ضرب تمرینی مربعی.jpg", "محیط و مساحت اشکال هندسی.jpg", "منظومه خورشیدی.jpg", "نقشه ایران.jpg", "نقشه جهان.jpg", /*"جدول ضرب حیوانات.jpg"*/]
  },
};

// Quantities must be sorted ascending
const allowedQuantities = [0, 20, 50, 100, 200, 300, 400, 500];
let cart = new Map(JSON.parse(localStorage.getItem('cart') || '[]'));

// --- Screen Management ---
const screens = {
    main: document.getElementById('mainSection'),
    gallery: document.getElementById('gallery'),
    cart: document.getElementById('cartSection')
};

function showScreen(screenName) {
    // Hide all screens
    for (let key in screens) {
        screens[key].style.display = 'none';
    }

    // Show the requested screen
    screens[screenName].style.display = 'flex'; // Use flex for these sections

    // Update history for back button support
    // Only push state if not going back via popstate or already on the screen
    if (history.state === null || history.state.screen !== screenName) {
        history.pushState({ screen: screenName }, '', `#${screenName}`);
    }

    // Specific actions for each screen
    if (screenName === 'gallery') {
        const currentGroupId = document.getElementById('bottomGroupSelect').value; // Get current selected group
        loadGroup(currentGroupId); // Reload current group
    } else if (screenName === 'cart') {
        renderCartList();
    }
}

// Handle browser's back button
window.addEventListener('popstate', (event) => {
    if (event.state && event.state.screen) {
        // Restore previous screen based on history state
        for (let key in screens) {
            screens[key].style.display = 'none';
        }
        screens[event.state.screen].style.display = 'flex';
        if (event.state.screen === 'gallery') {
            const currentGroupId = document.getElementById('bottomGroupSelect').value;
            loadGroup(currentGroupId);
        } else if (event.state.screen === 'cart') {
            renderCartList();
        }
    } else {
        // Fallback to main screen if no state (e.g., initial load or direct URL)
        showScreen('main');
    }
});


function enterAsUser() {
  showScreen('gallery');
  // Sync selected group in both dropdowns
  loadGroup(1); // Load the first group by default
}

function showAdminLogin() {
  // Hide initial login button and address/subtitle
  document.getElementById("loginSection").style.display = "none";
  document.getElementById("subtitle").style.display = "none";
  document.getElementById("address").style.display = "none";
  // Show admin login form
  document.getElementById("adminLogin").style.display = "flex";
}

function loginAsAdmin() {
  const pass = document.getElementById("adminPassword").value;
  if (pass === "Alireza55") {
    alert("علیرضا خوش آمدید!");
    // You might want to navigate to an admin panel or hide this form
    // For now, it just shows an alert
  } else {
    alert("ورود شما مجاز نیست");
  }
}

function changeGroup(val) {
  // Sync both dropdowns when one changes
  document.getElementById('bottomGroupSelect').value = val;
  document.getElementById('bottomGroupSelect').value = val;
  loadGroup(parseInt(val));
}

// Helper to generate options for the quantity dropdown
function generateQuantityOptions(selectedQty) {
    let optionsHtml = '';
    allowedQuantities.forEach(qty => {
        optionsHtml += `<option value="${qty}" ${qty === selectedQty ? 'selected' : ''}>${qty}</option>`;
    });
    return optionsHtml;
}

function loadGroup(groupId) {
  const container = document.getElementById("imagesContainer");
  container.innerHTML = ""; // پاک کردن تصاویر قبلی
  const info = groupInfo[groupId];

  // **شروع حلقه جدید برای استفاده از filenames**
  // این حلقه روی هر نام فایل که در آرایه filenames تعریف شده، یک بار تکرار می‌شود
  info.filenames.forEach(actualFilename => { // 'actualFilename' حالا مستقیماً نام فایل رو از آرایه می‌گیره
    
    const imagePath = `Image/${info.name}/${actualFilename}`; // استفاده از نام فایل واقعی

    // شناسه منحصر به فرد آیتم رو هم با نام فایل واقعی می‌سازیم
    const itemUniqueId = `${groupId}-${actualFilename}`; 
    const currentCartItem = cart.get(itemUniqueId);
    // اگر آیتم در سبد خرید بود، از تعدادش استفاده می‌کنیم، وگرنه 0
    const initialQty = currentCartItem ? currentCartItem.qty : 0; 

    const box = document.createElement("div");
    box.className = "image-box";

    let inCartMessage = '';
    if (currentCartItem && currentCartItem.qty > 0) {
        inCartMessage = `<p class="in-cart-display">موجود در سبد: ${currentCartItem.qty} عدد</p>`;
    }

    box.innerHTML = `
      <img src="${imagePath}" alt="پوستر ${info.name} - ${actualFilename}">
      <p style="font-weight: bold; margin-bottom: 5px;">${info.name} - ${actualFilename.replace(/\.jpg$/, '')}</p> 
      <p style="color: #4CAF50; font-weight: bold;">قیمت: ${info.price.toLocaleString()} ریال</p>
      <div style="display: flex; align-items: center; margin-top: 10px;">
        <label for="qty-select-${itemUniqueId}">تعداد:</label>
        <select id="qty-select-${itemUniqueId}" class="quantity-select" onchange="addToCart('${groupId}', '${actualFilename}', this.value)">
          ${generateQuantityOptions(initialQty)}
        </select>
        <button onclick="addToCart('${groupId}', '${actualFilename}')">افزودن‌ به سبد خرید</button>
      </div>
      ${inCartMessage}
    `;
    container.appendChild(box);
  }); // **پایان حلقه forEach**
  
  // بعد از بارگذاری کامل گروه، به بالای کانتینر اسکرول کنید
  // می‌توانید به خود imagesContainer یا به کل گالری (gallery) اسکرول کنید.
  // بهتره به خود گالری اسکرول کنیم که هدر و کنترل‌ها هم دیده بشن.
  document.getElementById('gallery').scrollIntoView({ behavior: 'smooth', block: 'start' });

}

function addToCart(groupId, filename) {
    const info = groupInfo[groupId];
    const itemUniqueId = `${groupId}-${filename}`;
    
    // Get quantity from the select dropdown corresponding to this item
    const qtySelect = document.getElementById(`qty-select-${itemUniqueId}`);
    const selectedQty = parseInt(qtySelect.value);

    if (selectedQty === 0) {
        // If quantity is 0, remove from cart if exists
        if (cart.has(itemUniqueId)) {
            removeFromCart(itemUniqueId); 
            // Update the gallery item's in-cart display after removal
            const inCartDisplayElement = qtySelect.parentNode.parentNode.querySelector('.in-cart-display');
            if (inCartDisplayElement) {
                inCartDisplayElement.remove();
            }
            alert(`"${info.name} - ${filename}" از سبد حذف شد.`);
        } else {
            alert('لطفاً تعداد را انتخاب کنید.');
        }
        return;
    }

    // Always set (override) to ensure "last choice" is recorded
    cart.set(itemUniqueId, {
        groupId: groupId,
        filename: filename,
        groupName: info.name,
        price: info.price,
        qty: selectedQty
    });
    
    saveCart();
    alert(`"${info.name} - ${filename}" به تعداد ${selectedQty} عدد به سبد خرید اضافه/به‌روز شد.`);

    // Update the in-cart display for the specific item in gallery
    const inCartDisplayElement = qtySelect.parentNode.parentNode.querySelector('.in-cart-display');
    if (inCartDisplayElement) {
        inCartDisplayElement.textContent = `موجود در سبد: ${selectedQty} عدد`;
    } else {
        const newInCartDisplay = document.createElement('p');
        newInCartDisplay.className = 'in-cart-display';
        newInCartDisplay.textContent = `موجود در سبد: ${selectedQty} عدد`;
        qtySelect.parentNode.parentNode.appendChild(newInCartDisplay);
    }
}

function updateCartItemQuantityFromDropdown(selectElement, itemUniqueId) {
    let newQty = parseInt(selectElement.value);

    if (isNaN(newQty) || newQty < 0) {
        // This case should ideally not happen with a dropdown of fixed values
        console.error("Invalid quantity selected from dropdown.");
        renderCartList(); // Re-render to revert to last valid quantity
        return;
    }
    
    if (newQty === 0) {
        removeFromCart(itemUniqueId);
    } else {
        let item = cart.get(itemUniqueId);
        item.qty = newQty;
        cart.set(itemUniqueId, item);
        saveCart();
        renderCartList(); // Re-render cart list after update
    }
}

function removeFromCart(itemUniqueId) {
    if (confirm('آیا مطمئنید می‌خواهید این محصول را از سبد حذف کنید؟')) {
        cart.delete(itemUniqueId);
        saveCart();
        renderCartList(); // Re-render cart list after removal
        // Also update the gallery view if currently displayed
        if (document.getElementById('gallery').style.display === 'flex') {
            const qtySelectInGallery = document.getElementById(`qty-select-${itemUniqueId}`);
            if (qtySelectInGallery) {
                qtySelectInGallery.value = 0; // Reset dropdown to 0
                const inCartDisplayElement = qtySelectInGallery.parentNode.parentNode.querySelector('.in-cart-display');
                if (inCartDisplayElement) {
                    inCartDisplayElement.remove(); // Remove the in-cart message
                }
            }
        }
    }
}

function clearCart() {
    if (confirm('آیا مطمئنید می‌خواهید کل سبد خرید را پاک کنید؟')) {
        cart.clear(); // Clear all items from the Map
        saveCart(); // Save the empty cart to localStorage
        renderCartList(); // Re-render the cart list to show it's empty
        alert('سبد خرید شما پاک شد.');
        // Also update the gallery view if currently displayed
        if (document.getElementById('gallery').style.display === 'flex') {
            loadGroup(document.getElementById('bottomGroupSelect').value); // Reload current group to reset all in-cart messages
        }
    }
}

function renderCartList() {
    const list = document.getElementById("cartList");
    const total = document.getElementById("totalPrice");
    list.innerHTML = ""; // Clear previous list
    let grouped = {}; // برای نمایش آیتم‌های تکی گروه‌بندی شده
    let groupedSummaries = {}; // برای خلاصه‌ی گروه‌ها
    let totalSum = 0; // مبلغ کل بدون باربری

    if (cart.size === 0) {
        list.innerHTML = "<p>سبد خرید شما خالی است.</p>";
        total.textContent = `مبلغ کل: 0 ریال`;
        return;
    }

    cart.forEach(item => {
        // گروه‌بندی برای نمایش آیتم‌های تکی
        if (!grouped[item.groupName]) grouped[item.groupName] = [];
        grouped[item.groupName].push(item);
        totalSum += item.qty * item.price;

        // محاسبه خلاصه‌ی گروه‌ها
        if (!groupedSummaries[item.groupName]) {
            groupedSummaries[item.groupName] = {
                totalQty: 0,
                totalPrice: 0
            };
        }
        groupedSummaries[item.groupName].totalQty += item.qty;
        groupedSummaries[item.groupName].totalPrice += item.qty * item.price;
    });

    // حالا نمایش آیتم‌های تکی، مثل قبل
    for (let groupName in grouped) {
        list.innerHTML += `<h4 style="margin-top: 15px; text-align: right; border-bottom: 1px dashed #eee; padding-bottom: 5px;">${groupName}</h4>`;
        grouped[groupName].forEach(item => {
            const itemUniqueId = `${item.groupId}-${item.filename}`;
            const itemDiv = document.createElement("div");
            itemDiv.className = "cart-item";
            itemDiv.innerHTML = `
                <div class="cart-item-info">
                    <p style="font-weight: bold; margin-bottom: 3px;"> ${item.filename.replace(/\.jpg$/, '')}</p>
                </div>
                <div class="quantity-control">
                    <select id="cart-qty-select-${itemUniqueId}" class="quantity-select"
                            onchange="updateCartItemQuantityFromDropdown(this, '${itemUniqueId}')">
                        ${generateQuantityOptions(item.qty)}
                    </select>
                    <button class="remove-btn" onclick="removeFromCart('${itemUniqueId}')">حذف</button>
                </div>
            `;
            list.appendChild(itemDiv);
        });
    }

    // --- NEW LOCATION: نمایش خلاصه‌ی گروه‌ها در پایین لیست آیتم‌ها ---
    list.innerHTML += `<hr style="margin: 15px 0; border: 0; border-top: 1px dashed #ccc;">`; // یک خط جداکننده قبل از خلاصه
    list.innerHTML += `<h3 style="margin-bottom: 10px;">خلاصه سفارش بر اساس گروه:</h3>`;
    for (let groupName in groupedSummaries) {
        const summary = groupedSummaries[groupName];
        list.innerHTML += `
            <div style="background-color: #e8f5e9; padding: 8px; margin-bottom: 5px; border-radius: 5px; text-align: right;">
                <p style="font-weight: bold; margin: 0;">${groupName}:</p>
                <p style="margin: 0; font-size: 0.9em;">تعداد کل: ${summary.totalQty} عدد - مجموع قیمت: ${summary.totalPrice.toLocaleString()} ریال</p>
            </div>
        `;
    }
    // یک خط جداکننده دیگر بعد از خلاصه گروه‌ها (اختیاری)
    list.innerHTML += `<hr style="margin: 15px 0; border: 0; border-top: 1px dashed #ccc;">`; 


    // --- محاسبه و نمایش هزینه باربری در سبد خرید ---
    const baseShippingThreshold = 85000000; 
    const costPerThreshold = 600000;     
    let calculatedShippingCost = 0;
    let shippingDisplayMessage = "";
    
    if (totalSum === 0) {
        calculatedShippingCost = 0;
        shippingDisplayMessage = `\n🚚 هزینه باربری: 0 ریال`;
    } else {
        const numberOfThresholds = Math.ceil(totalSum / baseShippingThreshold);
        calculatedShippingCost = numberOfThresholds * costPerThreshold;
        shippingDisplayMessage = `\n🚚 هزینه باربری (${numberOfThresholds} بسته): ${calculatedShippingCost.toLocaleString()} ریال `;
    }

    // اضافه کردن پیام هزینه باربری به سبد خرید
    list.innerHTML += `
        <div style="padding: 8px; margin-top: 10px; border-radius: 5px; text-align: right;">
            <p style="font-weight: bold; margin: 0;">${shippingDisplayMessage}</p>
        </div>
    `;
    // --- نمایش مبلغ کل نهایی (شامل باربری) ---
    const finalTotalWithShipping = totalSum + calculatedShippingCost;
    total.textContent = `💵 مبلغ کل سفارش: ${finalTotalWithShipping.toLocaleString()} ریال`;
}


function saveCart() {
  localStorage.setItem('cart', JSON.stringify(Array.from(cart.entries())));
}
function sendOrder() {
  if (cart.size === 0) {
    alert('سبد خرید شما خالی است.');
    return;
  }

  // گرفتن اطلاعات مشتری از فرم
  const customerName = document.getElementById('customerName').value.trim();
  const customerPhone = document.getElementById('customerPhone').value.trim();
  const customerAddress = document.getElementById('customerAddress').value.trim();

  // اعتبار سنجی فیلدهای مشتری
  if (!customerName || !customerPhone || !customerAddress) {
    alert('لطفاً نام و نام خانوادگی، شماره موبایل و آدرس کامل تحویل را وارد کنید.');
    return; // جلوگیری از ادامه ارسال سفارش
  }

  // ذخیره اطلاعات مشتری در localStorage برای استفاده‌های بعدی
  localStorage.setItem('customerName', customerName);
  localStorage.setItem('customerPhone', customerPhone);
  localStorage.setItem('customerAddress', customerAddress);

  const confirmation = confirm('آیا از ثبت و ارسال سفارش خود مطمئن هستید؟');

  if (confirmation) {
    let message = "🛒 سفارش من :  \n";

    // اضافه کردن اطلاعات مشتری به ابتدای پیام
    message += `\n👤 نام و نام خانوادگی: ${customerName}\n`;
    message += `📱 شماره موبایل: ${customerPhone}\n`;
    message += `📍 آدرس تحویل: ${customerAddress}\n`;

    let totalAmount = 0;
    let groupedItems = {};
    let groupedSummaries = {};

    cart.forEach(item => {
      // 1. For displaying item details by group
      if (!groupedItems[item.groupName]) {
        groupedItems[item.groupName] = [];
      }
      groupedItems[item.groupName].push(item);

      // 2. For calculating the final total amount of the shopping cart
      totalAmount += item.qty * item.price;

      // 3. For calculating the summary of each group (total quantity and total price)
      if (!groupedSummaries[item.groupName]) {
        groupedSummaries[item.groupName] = {
          totalQty: 0,
          totalPrice: 0
        };
      }
      groupedSummaries[item.groupName].totalQty += item.qty;
      groupedSummaries[item.groupName].totalPrice += item.qty * item.price;
    });

    // --- Display full item details (grouped) ---
    message += "\n--- جزئیات سفارش ---\n";
    for (let groupName in groupedItems) {
      message += `\n⤵️  ${groupName} 🔀 :\n`; // Added group title
      groupedItems[groupName].forEach(item => {
        message += `  - ${item.filename.replace(/\.jpg$/, '')} - تعداد: ${item.qty} عدد\n`; // Item details with indent
      });
    }
    message += "---------------------------------------\n";
    // --- Display order summary by group ---
    message += "\n--- خلاصه سفارش بر اساس گروه ---\n";
    for (let groupName in groupedSummaries) {
      const summary = groupedSummaries[groupName];
      message += `* ${groupName}: تعداد کل ${summary.totalQty} عدد - مجموع قیمت ${summary.totalPrice.toLocaleString()} ریال\n`;
    }
    message += "---------------------------------------\n"; // Adjusted line separator

    // --- Calculate and add variable/tiered shipping cost ---
    const baseShippingThreshold = 85000000; // 85,000,000 Rials (per tier)
    const costPerThreshold = 600000;     // 600,000 Rials (cost for each tier)

    let calculatedShippingCost = 0;
    let shippingMessage = "";
    let finalTotalAmount = totalAmount; // Final amount including shipping

    // If totalAmount is zero (empty cart), shipping is zero.
    if (totalAmount === 0) {
      calculatedShippingCost = 0;
      shippingMessage = "\n🚚 هزینه باربری: 0 ریال";
    }
    // If totalAmount is greater than zero, calculate tiers
    else {
      // Calculate the number of full or partial thresholds reached.
      const numberOfThresholds = Math.ceil(totalAmount / baseShippingThreshold);
      calculatedShippingCost = numberOfThresholds * costPerThreshold;
      shippingMessage = `\n🚚 هزینه‌باربری‌(‌${numberOfThresholds} بسته) : ${calculatedShippingCost.toLocaleString()} ریال `;
    }

    finalTotalAmount += calculatedShippingCost; // Add shipping cost to the final total

    message += shippingMessage; // Add the shipping message above the total amount


    // --- Display final total amount and supplementary messages ---
    message += `\n💵 مبلغ کل سفارش: ${finalTotalAmount.toLocaleString()} ریال`; // Use finalTotalAmount
    message += "       ---------------------------------------\n";
    message += `\n\n✅  سفارش شما با موفقیت ثبت شد . در اسرع وقت هماهنگی لازم با شما صورت می‌گیرد.`;

    const phoneNumber = "989010195885"; // Iranian WhatsApp number (with 98 prefix)
    const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;

    window.open(whatsappUrl, '_blank');
  } else {
    // اگر کاربر روی "Cancel" یا "لغو" کلیک کرد
    alert('ثبت سفارش لغو شد.');
  }
}
// Initial load: show main screen and add initial history state
window.onload = function() {
    showScreen('main');
    // Ensure the initial state is also recorded for history API
    history.replaceState({ screen: 'main' }, '', '#main');
    // Load any existing cart items to ensure gallery quantities are correct on load
    renderCartList(); // This also initializes the cart display if empty
};

</script>
</div>
<footer class="mt-auto py-6 text-gray-500 text-sm">
    <p>&copy; 2025 PosterIran. تمامی حقوق محفوظ است.</p>
</footer>
<script>
  </script>
<footer class="mt-auto py-6 text-gray-500 text-sm">
    <p> </p>
</footer>
<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/service-worker.js')
                .then(registration => {
                    console.log('Service Worker registered! Scope:', registration.scope);
                })
                .catch(err => {
                    console.log('Service Worker registration failed:', err);
                });
        });
    }
</script>

</body>
</html>
